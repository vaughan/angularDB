<html>
<head>
  <link rel="styleSheet" href="components/angular-ui-grid/ui-grid.min.css"/>
  <link rel="styleSheet" href="css/style.css"/>
  <script src="components/angular/angular.min.js"></script>
  <script src="components/angular-ui-grid/ui-grid.min.js"></script>
  <title>angularDB</title>
 </head>
 <body ng-app="dbApp" ng-controller="dbController">
   <div id=dbObjects>
     <li>
       <ul ng-repeat="table in tables" ng-click="openTable(table);">{{table}}</ul>
      </li>
    </div>
   <div id=content>
     <h3>{{tableName}}</h3>
     <div ui-grid="gridOptions" class="grid" ui-grid-edit ui-grid-row-edit ui-grid-resize-columns ui-grid-cellNav></div>
    </div>
  </body>
<script>
var app = angular.module("dbApp", ['ui.grid','ui.grid.edit','ui.grid.rowEdit','ui.grid.resizeColumns','ui.grid.cellNav']);
app.filter('reverse', function() {
  return function(items) {
    return items.slice().reverse();
  };
 });
app.controller("dbController", ['$scope', '$http', '$q', '$timeout', function($scope, $http, $q, $timeout) {
  $scope.columns = [{ field: 'name' }, { field: 'gender' }];
  $scope.gridOptions = {
    columnDefs: $scope.columns
   };
  $scope.saveRow = function( rowEntity ) {
      //sql update
      var sql = "update '" + $scope.tableName + "' set ";
      var fields = Object.keys(rowEntity);
      //delete array elements that are not table fields to be updated: rowid and $$hashKey
      var deleteIndex = fields.indexOf('rowid');
      fields.splice(deleteIndex, 1);
	  deleteIndex = fields.indexOf('$$hashKey');
      fields.splice(deleteIndex, 1);
      
      sql += fields.map(function(field) {
        return field + "='" + rowEntity[field] + "'";
       }).join(", ");
      sql += " where rowid = " + rowEntity['rowid']; 

      var sqlUpdate = $http.get("/sql?get=" + sql);
      var defer = $q.defer();
      $scope.gridApi.rowEdit.setSavePromise( $scope.gridApi.grid, rowEntity, defer.promise );
      sqlUpdate.then(
        function(payload) {
          if (payload.data.result === 'success') {
            defer.resolve();
           } else {
            alert('unwanted http response: ' + JSON.stringify(payload));
            defer.reject(payload);
           }
         },
        function(err) {
          alert('http err: ' + JSON.stringify(err));
          defer.reject(err);
         }
       );
     };
  $scope.gridOptions.onRegisterApi = function(gridApi){
    $scope.gridApi = gridApi;
    gridApi.rowEdit.on.saveRow($scope, $scope.saveRow);
   };   
  $scope.openTable = function(table) {
    $http.get("/table?get=" + table)
      .success(function(response) {
        $scope.tableName = response.table;
        $scope.columns.splice(0,$scope.columns.length);
        response.fields.forEach(function(field) {
		  $scope.columns.push(field);
	     });
	    //alert(JSON.stringify(response.rows));
        $scope.gridOptions.data = response.rows;
       });
   };
  $scope.getTables = function() {
    $http.get("/tables")
      .success(function(response) {
        $scope.tables = response;
       });    
   };
  $scope.getTables();
 }]);
</script>

</html>
